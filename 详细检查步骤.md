## 第一步：修复Django模块导入问题

### 1.1 检查wsgi.py文件内容

```bash
cat /var/www/scenic/backend/wsgi.py
```

这一步可以帮助确认WSGI配置的正确性，了解项目如何定义WSGI应用。

### 1.2 修改Gunicorn服务配置

```bash
sudo nano /etc/systemd/system/scenic-gunicorn.service
```

将内容更新为：
```
[Unit]
Description=Scenic Gunicorn Daemon
After=network.target

[Service]
User=www-data
Group=www-data
WorkingDirectory=/var/www/scenic/backend
Environment="PYTHONPATH=/var/www/scenic"
Environment="DJANGO_SETTINGS_MODULE=backend.settings"
ExecStart=/var/www/scenic/venv/bin/gunicorn --workers 3 --bind 127.0.0.1:8000 backend.wsgi:application

[Install]
WantedBy=multi-user.target
```

保存并退出编辑器（Ctrl+X，然后Y，再按Enter）。

## 第二步：配置Nginx代理

### 2.1 创建Nginx站点配置

```bash
sudo nano /etc/nginx/sites-available/scenic
```

添加以下内容：
```
server {
    listen 80;
    server_name _;  # 替换为您的域名或IP地址

    # 静态文件配置
    location /static/ {
        alias /var/www/scenic/static/;
    }

    location /media/ {
        alias /var/www/scenic/media/;
    }

    # API请求代理
    location /api/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://127.0.0.1:8000;
    }

    # 管理员接口代理
    location /admin/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_pass http://127.0.0.1:8000;
    }

    # 其他请求发送到前端
    location / {
        root /var/www/scenic/frontend/dist;
        try_files $uri $uri/ /index.html;
    }
}
```

保存并退出编辑器。

### 2.2 启用新的Nginx配置

```bash
# 创建符号链接启用配置
sudo ln -s /etc/nginx/sites-available/scenic /etc/nginx/sites-enabled/

# 移除默认配置（如果存在）
sudo rm -f /etc/nginx/sites-enabled/default
```

### 2.3 检查Nginx配置语法

```bash
sudo nginx -t
```

确保没有语法错误。

## 第三步：设置正确的目录权限

### 3.1 设置静态和媒体文件目录权限

```bash
# 创建目录（如果不存在）
sudo mkdir -p /var/www/scenic/static
sudo mkdir -p /var/www/scenic/media

# 设置权限
sudo chown -R www-data:www-data /var/www/scenic/static
sudo chown -R www-data:www-data /var/www/scenic/media
sudo chmod -R 755 /var/www/scenic/static
sudo chmod -R 755 /var/www/scenic/media
```

### 3.2 确保前端dist目录具有正确权限

```bash
sudo chown -R www-data:www-data /var/www/scenic/frontend/dist
sudo chmod -R 755 /var/www/scenic/frontend/dist
```

## 第四步：收集Django静态文件

### 4.1 使用Django管理命令收集静态文件

```bash
cd /var/www/scenic/backend
source /var/www/scenic/venv/bin/activate
python manage.py collectstatic --noinput
```

## 第五步：重启服务

### 5.1 重新加载systemd配置

```bash
sudo systemctl daemon-reload
```

### 5.2 重启Gunicorn服务

```bash
sudo systemctl restart scenic-gunicorn
```

### 5.3 检查Gunicorn状态

```bash
sudo systemctl status scenic-gunicorn
```

确保服务状态为"active (running)"。如果有错误，检查日志：

```bash
sudo journalctl -u scenic-gunicorn -n 50
```

### 5.4 重启Nginx服务

```bash
sudo systemctl restart nginx
```

### 5.5 检查Nginx状态

```bash
sudo systemctl status nginx
```

## 第六步：调试常见问题

### 6.1 检查Gunicorn进程是否正在运行

```bash
ps aux | grep gunicorn
```

### 6.2 测试API端点

```bash
curl http://localhost:8000/api/
```

### 6.3 检查日志文件

```bash
# Nginx错误日志
sudo tail -f /var/log/nginx/error.log

# Django日志（如果配置了）
tail -f /var/www/scenic/backend/logs/django.log
```

### 6.4 如果仍然有502错误

检查是否存在防火墙问题：

```bash
# 允许80端口
sudo ufw allow 80/tcp

# 检查防火墙状态
sudo ufw status
```

## 第七步：如果要切换回Unix套接字（可选，仅在TCP工作后）

### 7.1 创建套接字目录

```bash
sudo mkdir -p /var/www/scenic/run
sudo chown www-data:www-data /var/www/scenic/run
sudo chmod 755 /var/www/scenic/run
```

### 7.2 修改Gunicorn配置

```bash
sudo nano /etc/systemd/system/scenic-gunicorn.service
```

修改ExecStart行：
```
ExecStart=/var/www/scenic/venv/bin/gunicorn --workers 3 --bind unix:/var/www/scenic/run/scenic.sock backend.wsgi:application
```

### 7.3 更新Nginx配置

```bash
sudo nano /etc/nginx/sites-available/scenic
```

将API代理部分修改为：
```
location /api/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass http://unix:/var/www/scenic/run/scenic.sock;
}

location /admin/ {
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass http://unix:/var/www/scenic/run/scenic.sock;
}
```

### 7.4 重新加载并重启服务

```bash
sudo systemctl daemon-reload
sudo systemctl restart scenic-gunicorn
sudo systemctl restart nginx
```

完成以上步骤后，您的Django应用应该能够正常运行，前端也能正确地调用API了。

需要我详细解释任何特定步骤吗？

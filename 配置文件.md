# 全国景区数据分析及可视化系统部署配置

## 前后端配置修改

### 1. 前端配置修改

#### 修改前端API请求地址 (forward/my-forward/src/api/axios.ts)

```typescript
// 修改baseURL为线上域名
const instance = axios.create({
  baseURL: 'https://www.k-irito.online/api',  // 或者使用 http://1.15.103.26/api
  timeout: 30000,
  headers: {
    'Content-Type': 'application/json'
  },
  withCredentials: true
});
```

#### 修改Vite配置文件 (forward/my-forward/vite.config.ts)

```typescript
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import { resolve } from 'path'

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      '@': resolve(__dirname, 'src'),
    },
  },
  // 本地开发时的代理配置，生产环境部署时实际不会使用
  server: {
    port: 3000,
    open: true,
    proxy: {
      '/api': {
        target: 'http://localhost:8001',
        changeOrigin: true
      },
      '/media': {
        target: 'http://localhost:8001',
        changeOrigin: true
      }
    }
  },
  // 添加生产环境构建配置
  build: {
    outDir: 'dist',
    assetsDir: 'assets',
    // 可选：启用source map
    sourcemap: false,
    // 可选：压缩配置
    minify: 'terser',
    terserOptions: {
      compress: {
        drop_console: true,
        drop_debugger: true
      }
    }
  }
})
```

#### 创建环境变量文件 (forward/my-forward/.env.production)
```
VITE_API_BASE_URL=https://www.k-irito.online/api
```

### 2. 后端配置修改

#### 修改Django后端配置 (backend/settings.py)

```python
# 关闭Debug模式
DEBUG = False

# 设置允许的主机
ALLOWED_HOSTS = ['www.k-irito.online', '1.15.103.26', 'localhost']

# 数据库配置（可以保留相同配置或修改为更安全的配置）
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'scenic_area',
        'USER': 'root',  # 建议使用更安全的用户名
        'PASSWORD': 'your_secure_password',  # 修改为安全的密码
        'HOST': 'localhost',
        'PORT': '3306',
    }
}

# 静态文件配置
STATIC_URL = '/static/'
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')

# 媒体文件配置
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# 修改CORS和CSRF配置
CORS_ALLOWED_ORIGINS = [
    'https://www.k-irito.online',
    'http://1.15.103.26',
    'http://localhost:8080',
    'http://localhost:3000',
]

CSRF_TRUSTED_ORIGINS = [
    'https://www.k-irito.online',
    'http://1.15.103.26',
    'http://localhost:8080',
    'http://localhost:3000',
]

# 安全配置
CSRF_COOKIE_SECURE = True  # 仅通过HTTPS发送
CSRF_COOKIE_HTTPONLY = True
SESSION_COOKIE_SECURE = True
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'
SECURE_HSTS_SECONDS = 31536000  # 1年
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True
SECURE_SSL_REDIRECT = True  # 强制HTTPS请求

# Redis缓存配置
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}

# 会话引擎配置
SESSION_ENGINE = 'django.contrib.sessions.backends.cache'
SESSION_CACHE_ALIAS = 'default'
```

## Nginx和Gunicorn配置

### 1. Nginx配置文件 (/etc/nginx/sites-available/scenic_data_visualization)

```nginx
server {
    listen 80;
    server_name www.k-irito.online 1.15.103.26;
    
    # 将HTTP请求重定向到HTTPS
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name www.k-irito.online 1.15.103.26;
    
    # SSL证书配置
    ssl_certificate /etc/nginx/ssl/k-irito.online.crt;
    ssl_certificate_key /etc/nginx/ssl/k-irito.online.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 前端静态文件配置
    location / {
        root /var/www/scenic_data_visualization;
        try_files $uri $uri/ /index.html;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }
    
    # API请求代理配置
    location /api/ {
        proxy_pass http://localhost:8001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }
    
    # 媒体文件配置
    location /media/ {
        alias /var/www/scenic_data_visualization/media/;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }
    
    # 静态文件配置（后端静态文件）
    location /static/ {
        alias /var/www/scenic_data_visualization/staticfiles/;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000";
    }
    
    # 日志配置
    access_log /var/log/nginx/scenic_data_visualization_access.log;
    error_log /var/log/nginx/scenic_data_visualization_error.log;
    
    # 安全相关配置
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data: blob:; style-src 'self' 'unsafe-inline'; font-src 'self'; connect-src 'self' https://api.mapbox.com;" always;
    
    # 限制客户端请求大小
    client_max_body_size 20M;
}
```

### 2. Gunicorn配置文件 (/etc/systemd/system/gunicorn_scenic.service)

```ini
[Unit]
Description=Gunicorn daemon for Scenic Data Visualization Backend
After=network.target

[Service]
User=ubuntu
Group=ubuntu
WorkingDirectory=/var/www/backend
ExecStart=/var/www/backend/venv/bin/gunicorn \
          --workers 4 \
          --worker-class=gevent \
          --worker-connections=1000 \
          --bind 127.0.0.1:8001 \
          wsgi:application \
          --access-logfile /var/log/gunicorn/scenic_access.log \
          --error-logfile /var/log/gunicorn/scenic_error.log \
          --log-level info \
          --timeout 120

Restart=on-failure
RestartSec=5s

[Install]
WantedBy=multi-user.target
```

### 3. Gunicorn配置文件 (/var/www/backend/gunicorn.conf.py)

```python
# gunicorn.conf.py
import multiprocessing

# 绑定的IP和端口
bind = "127.0.0.1:8001"

# worker 进程数，通常设置为 CPU 核心数的 2-4 倍
workers = multiprocessing.cpu_count() * 2 + 1

# worker类型: gevent适合处理高并发请求
worker_class = "gevent"

# 每个worker的最大并发请求数
worker_connections = 1000

# 请求超时时间（秒）
timeout = 120

# 日志配置
accesslog = "/var/log/gunicorn/scenic_access.log"
errorlog = "/var/log/gunicorn/scenic_error.log"
loglevel = "info"

# 进程名称
proc_name = "scenic_gunicorn"

# 守护进程模式
daemon = False

# 预加载应用
preload_app = True

# 限制每个worker的最大请求数，达到后自动重启worker
max_requests = 1000
max_requests_jitter = 50
```

## 部署步骤总结

1. 前端构建
   - 修改 `axios.ts` 中的 baseURL
   - 创建 `.env.production` 文件
   - 运行 `npm run build` 生成 dist 目录
   - 将 dist 目录内容复制到 `/var/www/scenic_data_visualization`

2. 后端部署
   - 修改 Django 的 settings.py 配置
   - 在服务器上安装 Gunicorn 和 Gevent
   - 创建 Gunicorn 配置文件
   - 配置 systemd 服务

3. 数据库设置
   - 安装 MySQL 并创建数据库和用户
   - 确保正确配置数据库连接

4. Nginx 配置
   - 创建 Nginx 配置文件
   - 创建符号链接到 sites-enabled
   - 获取并配置 SSL 证书
   - 测试并重启 Nginx

5. 媒体文件处理
   - 创建媒体文件目录
   - 确保正确设置目录权限
   - 将现有媒体文件复制到服务器

6. 安全配置
   - 设置防火墙规则
   - 安装并配置 fail2ban
   - 开启 HTTPS 并配置重定向

7. 系统监控
   - 配置日志轮转
   - 设置监控和备份策略
